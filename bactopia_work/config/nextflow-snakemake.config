// ============================================================
// Minimal Nextflow config for Bactopia on Duke HPC (Apptainer)
// ============================================================

process {
  cpus   = 8
  memory = '16 GB'
  scratch = true

  env = [
    'TMPDIR'         : '/work/nfb9/projects/P-REALM/tmp',
    'XDG_CACHE_HOME' : '/work/nfb9/projects/P-REALM/tmp/.xdg_cache',
    'NUMBA_CACHE_DIR': '/work/nfb9/projects/P-REALM/tmp/numba_cache'
  ]

  // Heavier steps
  withName: /PANAROO|PIRATE|IQTREE|GUBBINS|SNPDISTS/ {
    cpus   = 12
    memory = '32 GB'
  }

  // Gubbins: disable Numba JIT and use per-task caches
  withName: /.*GUBBINS.*MODULE.*/ {
    containerOptions = ' --env NUMBA_DISABLE_JIT=1'
    beforeScript = '''
      export NUMBA_CACHE_DIR="$PWD/.numba_cache"
      export XDG_CACHE_HOME="$PWD/.xdg_cache"
      mkdir -p "$NUMBA_CACHE_DIR" "$XDG_CACHE_HOME"
      echo "NUMBA_DISABLE_JIT=${NUMBA_DISABLE_JIT:-unset}" > .gubbins_env.proof
      set -euo pipefail
    '''
  }
}

apptainer {
  cacheDir = '/hpc/group/taylorlab/containers/apptainer_cache'
}

executor {
  name = 'local'
  queueSize = 8
}

workDir = '/work/nfb9/projects/P-REALM/nxf_work'

// Optional minimal run metadata
timeline { enabled = true; file = 'bactopia_timeline.html' }
trace    { enabled = true; file = 'bactopia_trace.txt'    }
report   { enabled = true; file = 'bactopia_report.html'  }
