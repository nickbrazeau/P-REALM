// ============================================================
// config/nextflow-snakemake.config
// Robust Nextflow config for Bactopia on Duke HPC (Apptainer)
// ============================================================

// -----------------------------
// Global parameters
// -----------------------------
params {
  // Disable Numba JIT to prevent Gubbins numba caching errors
  gubbins_disable_jit = true

  // Optional: explicitly declare scratch/work path if you like to control it
  scratch_root = '/work/nfb9/projects/P-REALM/tmp'
}

// -----------------------------
// Process defaults
// -----------------------------
process {
  cpus   = 8
  memory = '16 GB'
  shell  = ['/bin/bash', '-ueo', 'pipefail'] // safer execution mode

  // Local scratch: useful on Dukeâ€™s DCC nodes for temporary large files
  scratch = true

  // Common environment variables applied to all processes
  env = [
    'NUMBA_DISABLE_CACHING': '1',
    'NUMBA_CACHE_DIR'      : '/tmp/numba',
    'TMPDIR'               : params.scratch_root
  ]

  // Heavy-hitters: give more resources
  withName: /GUBBINS_MODULE|PANAROO_RUN|PIRATE_MODULE|IQTREE_MODULE|SNPDISTS_/ {
    cpus   = 12
    memory = '32 GB'
  }

  // Specialized fix for Gubbins numba JIT crash
  withName: /BACTOPIATOOLS:SNIPPY:GUBBINS:GUBBINS_MODULE/ {
    beforeScript = '''
      # ensure writable per-task caches
      export NUMBA_CACHE_DIR="$PWD/.numba_cache"
      export XDG_CACHE_HOME="$PWD/.xdg_cache"
      mkdir -p "$NUMBA_CACHE_DIR" "$XDG_CACHE_HOME"

      # optionally disable JIT if requested
      if [[ "${params.gubbins_disable_jit}" == "true" ]]; then
        export NUMBA_DISABLE_JIT=1
        echo "NUMBA JIT disabled for Gubbins."
      fi
    '''
  }
}

// -----------------------------
// Container and cache behavior
// -----------------------------
apptainer {
  cacheDir = '/hpc/group/taylorlab/containers/apptainer_cache'
}

// -----------------------------
// Execution environment
// -----------------------------
executor {
  // Default to local (you can override with Slurm later)
  name = 'local'
  queueSize = 8
}

// -----------------------------
// Work directory location
// -----------------------------
// Use a large /work path instead of home for Nextflow temp files
workDir = System.getenv('NXF_WORK') ?: '/work/nfb9/projects/P-REALM/nxf_work'

// -----------------------------
// Misc convenience
// -----------------------------
timeline {
  enabled = true
  file = 'bactopia_timeline.html'
}
trace {
  enabled = true
  file = 'bactopia_trace.txt'
}
report {
  enabled = true
  file = 'bactopia_report.html'
}
