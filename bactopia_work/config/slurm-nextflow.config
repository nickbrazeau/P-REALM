// ============================================================
// Minimal Nextflow config for Bactopia on Duke HPC (Apptainer)
// ============================================================

// -----------------------------------------
// Apptainer & Slurm
// -----------------------------------------
singularity.enabled = false
apptainer.enabled   = true

apptainer {
    cacheDir   = '/work/nfb9/apptainer_cache'
    runOptions = '--bind /hpc --bind /work'
}

executor {
    name      = 'slurm'
    queueSize = 25   // Let Slurm handle dispatch but bite-size
    queue    = 'common'
    // avoid bad nodes
    clusterOptions = '--partition=common --exclude=dcc-core-02'
}

// -----------------------------------------
// Process-level resources
// -----------------------------------------
process {

    // Default resources for “normal” steps
    cpus    = 8
    memory  = '64 GB'
    time    = '24h'
    scratch = true

    env = [
        'XDG_CACHE_HOME' : '/work/nfb9/projects/P-REALM/tmp/.xdg_cache',
        'NUMBA_CACHE_DIR': '/work/nfb9/projects/P-REALM/tmp/numba_cache'
    ]

    // Global: ensure every process has a writable temp directory
    beforeScript = '''
        export MPLCONFIGDIR="$PWD/tmp/matplotlib"
        mkdir -p "$MPLCONFIGDIR"
        '''

    errorStrategy = 'retry'
    maxRetries    = 5

    // -----------------------------------------
    // Assemblies (Shovill/SKESA) – moderately heavy
    // -----------------------------------------
    withName: 'BACTOPIA:ASSEMBLER*' {
        cpus   = 8
        memory = '36 GB'
        time   = '24h'
    }

    // -----------------------------------------
    // Bakta annotation – general resources
    // -----------------------------------------
    withName: 'BACTOPIA:ANNOTATOR*' {
        cpus   = 8
        memory = '36 GB'
        time   = '24h'
    }

    // -----------------------------------------
    // Bakta annotation – force node-local tmp for AMR (expert_amr)
    // -----------------------------------------
    withName: 'BACTOPIA:ANNOTATOR:BAKTA_RUN' {
        cpus   = 8
        memory = '36 GB'
        time   = '24h'

        beforeScript = '''
            # Node-local tmp to avoid NFS ".nfs..." cleanup issues in Bakta's AMRFinder
            export TMPDIR="/tmp/bakta-$NF_TASK_ID"
            mkdir -p "$TMPDIR"

            # Node-local Matplotlib cache (if Bakta ever triggers MPL)
            export MPLCONFIGDIR="$TMPDIR/matplotlib"
            mkdir -p "$MPLCONFIGDIR"
        '''
    }

    // -----------------------------------------
    // MLST
    // -----------------------------------------
    withName: 'BACTOPIA:MLST:MLST_MODULE' {
        shell = ['/bin/bash','-uo','pipefail']
        errorStrategy = 'retry'
        maxRetries    = 2
    }

    // -----------------------------------------
    // AMRFinder – node-local tmp to avoid NFS cleanup issues
    // (standalone Bactopia AMRFinder+ tool)
    // -----------------------------------------
    withName: 'BACTOPIA:AMRFINDERPLUS:AMRFINDERPLUS_RUN' {
        beforeScript = '''
            # Use node-local tmp for AMRFinder to avoid NFS ".nfs" cleanup issues
            export TMPDIR="/tmp/amrfinder-$NF_TASK_ID"
            mkdir -p "$TMPDIR"
        '''
    }

    // -----------------------------------------
    // Pangenome / heavy comparative steps
    // -----------------------------------------
    withName: '/BACTOPIA:PANGENOME:.*' {
        cpus   = 16
        memory = '256 GB'
        time   = '48h'
    }

    // -----------------------------------------
    // Gubbins – disable Numba JIT & use per-task caches & use short TMPDIR
    // -----------------------------------------
    withName: /.*GUBBINS.*MODULE.*/ {
        // Turn off Nextflow scratch staging for this step —
        // that /tmp/nxf.* path is exactly what breaks AF_UNIX
        scratch = false

        // Push key env vars directly into the container
        containerOptions = '''
          --env NUMBA_DISABLE_JIT=1 \
          --env TMPDIR=/tmp/gubbins \
          --env TEMP=/tmp/gubbins \
          --env TMP=/tmp/gubbins \
          --env MP_TMPDIR=/tmp/gubbins
        '''.trim()

        beforeScript = '''
            # Use a very short temp directory path inside the container
            export TMPDIR=/tmp/gubbins
            export TEMP=/tmp/gubbins
            export TMP=/tmp/gubbins
            export MP_TMPDIR=/tmp/gubbins
            mkdir -p /tmp/gubbins

            # Per-task caches in the work dir (shorter than nested /tmp/nxf.*)
            export NUMBA_CACHE_DIR="$PWD/.numba_cache"
            export XDG_CACHE_HOME="$PWD/.xdg_cache"
            mkdir -p "$NUMBA_CACHE_DIR" "$XDG_CACHE_HOME"

            echo "NUMBA_DISABLE_JIT=${NUMBA_DISABLE_JIT:-unset}" > .gubbins_env.proof
            set -euo pipefail
        '''
    }


    // -----------------------------------------
    // IQ-TREE phylogenetics
    // -----------------------------------------
    withName: /IQTREE/ {
        cpus   = 12
        memory = '48 GB'
        time   = '48h'
    }

    // -----------------------------------------
    // SNP distance matrix – can be memory heavy
    // -----------------------------------------
    withName: /SNPDISTS/ {
        cpus   = 8
        memory = '32 GB'
        time   = '24h'
    }
}

// -----------------------------------------
// Work directory & metadata
// -----------------------------------------
workDir = '/work/nfb9/projects/P-REALM/nxf_work'

timeline { enabled = true; file = 'bactopia_timeline.html' }
trace    { enabled = true; file = 'bactopia_trace.txt' }
report   { enabled = true; file = 'bactopia_report.html' }
