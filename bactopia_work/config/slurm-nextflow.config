// ============================================================
// Minimal Nextflow config for Bactopia on Duke HPC (Apptainer)
// ============================================================

// -----------------------------------------
// Apptainer & Slurm
// -----------------------------------------
singularity.enabled = false
apptainer.enabled   = true

apptainer {
    cacheDir   = '/hpc/group/taylorlab/containers/apptainer_cache'
    runOptions = '--bind /hpc --bind /work'
}

executor {
    name      = 'slurm'
    queueSize = 200   // Let Slurm handle dispatch
}

// -----------------------------------------
// Process-level resources
// -----------------------------------------
process {

    // Default resources for “normal” steps
    cpus    = 8
    memory  = '64 GB'
    time    = '24h'
    scratch = true

    env = [
        'XDG_CACHE_HOME' : '/work/nfb9/projects/P-REALM/tmp/.xdg_cache',
        'NUMBA_CACHE_DIR': '/work/nfb9/projects/P-REALM/tmp/numba_cache'
    ]

    // Global: ensure every process has a writable temp directory
    beforeScript = '''
        export TMPDIR="$PWD/tmp"
        mkdir -p "$TMPDIR"
        '''

    // Retry transient failures (e.g., flaky I/O, node issues)
    errorStrategy = 'retry'
    maxRetries    = 3
    maxErrors     = '-1'

    // -----------------------------------------
    // Assemblies (Shovill/SKESA) – moderately heavy
    // -----------------------------------------
    withName: 'BACTOPIA:ASSEMBLER*' {
        cpus   = 8
        memory = '36 GB'
        time   = '24h'
    }

    // -----------------------------------------
    // Bakta annotation – moderate
    // -----------------------------------------
    withName: 'BACTOPIA:ANNOTATOR*' {
        cpus   = 8
        memory = '36 GB'
        time   = '24h'
    }

    // -----------------------------------------
    // MSLT issue
    // -----------------------------------------
    withName: 'BACTOPIA:MLST:MLST_MODULE' {
      // Keep strict-ish flags but no '-e'
      shell = ['/bin/bash','-uo','pipefail']

      // Optional: be forgiving if MLST flaps on PubMLST/network/db
      errorStrategy = 'retry'
      maxRetries    = 2
    }

    // -----------------------------------------
    // Pangenome / heavy comparative steps
    // -----------------------------------------
    withName: '/BACTOPIA:PANGENOME:.*' {
        cpus   = 16
        memory = '256 GB'
        time   = '48h'
    }

    // -----------------------------------------
    // Gubbins – disable Numba JIT & use per-task caches
    // -----------------------------------------
    withName: /.*GUBBINS.*MODULE.*/ {
        containerOptions = ' --env NUMBA_DISABLE_JIT=1'
        beforeScript = '''
            export NUMBA_CACHE_DIR="$PWD/.numba_cache"
            export XDG_CACHE_HOME="$PWD/.xdg_cache"
            mkdir -p "$NUMBA_CACHE_DIR" "$XDG_CACHE_HOME"
            echo "NUMBA_DISABLE_JIT=${NUMBA_DISABLE_JIT:-unset}" > .gubbins_env.proof
            set -euo pipefail
        '''
    }

    // -----------------------------------------
    // IQ-TREE phylogenetics
    // -----------------------------------------
    withName: /IQTREE/ {
        cpus   = 12
        memory = '48 GB'
        time   = '48h'
    }

    // -----------------------------------------
    // SNP distance matrix – can be memory heavy
    // -----------------------------------------
    withName: /SNPDISTS/ {
        cpus   = 8
        memory = '32 GB'
        time   = '24h'
    }
}

// -----------------------------------------
// Work directory & metadata
// -----------------------------------------
workDir = '/work/nfb9/projects/P-REALM/nxf_work'

timeline { enabled = true; file = 'bactopia_timeline.html' }
trace    { enabled = true; file = 'bactopia_trace.txt' }
report   { enabled = true; file = 'bactopia_report.html' }
